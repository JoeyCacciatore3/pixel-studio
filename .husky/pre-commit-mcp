#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# MCP-Enhanced Pre-Commit Hook
# Runs smart test selection based on changed files

echo "ğŸ” MCP Pre-Commit: Analyzing changed files..."

# Get changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | tr '\n' ',' | sed 's/,$//')

if [ -z "$CHANGED_FILES" ]; then
  echo "â„¹ï¸  No changed files detected. Skipping MCP test selection."
  exit 0
fi

echo "ğŸ“‹ Changed files: $CHANGED_FILES"

# Check if MCP is enabled
if [ "$MCP_ENABLED" != "true" ]; then
  echo "â„¹ï¸  MCP not enabled. Set MCP_ENABLED=true to use MCP test selection."
  exit 0
fi

# Run MCP test runner with affected tests
echo "ğŸ§ª Running affected tests..."
tsx scripts/mcp-test-runner.ts --affected --changed-files "$CHANGED_FILES" || {
  echo "âŒ Tests failed. Please fix issues before committing."
  exit 1
}

echo "âœ… All affected tests passed!"
